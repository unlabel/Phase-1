# Проектирование БД: Книжный магазин (2НФ)
Привет! Продолжим проектировать базу данных для книжного магазина. Уже существующие данные собраны в папке `data`.

Это задание — продолжение [предыдущего](https://github.com/part-time-javascript-elbrus-bootcamp/db-design-1nf-books). Если прежнее задание не выполнено, не страшно. Ознакомься с тем, что такое первая нормальная форма, а затем приступай к этому заданию.

Используй нормализацию в проектировании — необходимо привести все таблицы `books` ко второй нормальной форме (2НФ).

## Вторая нормальная форма (2НФ)

Таблица находится во второй нормальной форме, если соблюдены все условия:
1. таблица находится в первой нормальной форме,
2. в таблице нет неключевых атрибутов, которые зависят от *части* составного потенциального ключа.

## Release 1. Спроектировать базу данных
Заметь, что теперь в таблице с книгами появился атрибут `condition` — это состояние книги. Атрибут `isbn` больше не может быть ключом, так как книги с одинаковым ISBN могут быть в разных состояниях.

Потенциальный ключ (candidate key) теперь — составной ключ `isbn` и `condition`. Однако неключевой атрибут `title` зависит от части этого ключа — от значения ISBN.

Приведи все таблицы к 2НФ. Добавь новые таблицы, если это необходимо — все они также должны быть в 2НФ. Не забудь проверять каждую таблицу на соответствие 1НФ прежде чем проверять её на 2НФ.

Ответь на следующие вопросы:
1. Между какими таблицами есть связи?
2. Какие это связи? Один к одному, один ко многим или многие ко многим?

Нарисуй entity relationship diagram (ERD) для всех таблиц, нужных в базе данных. Используй ручку и бумагу или любой другой инструмент для рисования диаграмм. Можно воспользоваться сервисом [drawSQL](https://drawsql.app/) — в каждой диаграмме можно создать до 15 таблиц бесплатно.

<!-- markdownlint-disable no-inline-html -->
<details>
<summary>Ответ: вариант проекта БД с таблицами в 2НФ</summary>
<ol>
<li><b>authors:</b> id (PK), name</li>
<li><b>genres:</b> id (PK), name</li>
<li><b>conditions:</b> id (PK), name</li>
<li><b>books:</b> isbn (PK), title</li>
<li><b>copies:</b> id (PK), isbn (FK), amount, condition_id (FK)</li>
<li><b>book_genres:</b> isbn (PK, FK), genre_id (PK, FK)</li>
<li><b>book_authors:</b> isbn (PK, FK), author_id (PK, FK)</li>
</ol>
</details>
<!-- markdownlint-enable no-inline-html -->

## Release 2. Написать SQL-запросы для создания и удаления таблиц
Работай в файле `sql/migration.sql`.

Используя дизайн базы данных, напиши SQL запросы для создания необходимых таблиц. Проверь, что запросы выполняются без ошибок.

Также напиши запросы для удаления необходимых таблиц. Проверь, что все запросы выполняются без ошибок — как на удаление, так и на создание таблиц.

Сделай как минимум один коммит для этого релиза.

## Release 3. Написать SQL-запросы для заполнения таблиц данными и их очистки
Работай в файле `sql/seeder.sql`.

Напиши SQL запросы для заполнения таблиц исходными данными. Проверь, что запросы выполняются без ошибок.

---
<!-- markdownlint-disable no-inline-html -->
<details>
<summary>Муторно заполнять базу данными?</summary>
Вспомни, что ты программист, а файлы в формате CSV и SQL — это всего лишь текстовые файлы. Напиши скрипт на JavaScript, который будет генерировать SQL запросы для заполнения таблиц. Запусти этот скрипт в консоли, скопируй результат и вставь в файл <code>sql/seeder.sql</code>.
</details>
<!-- markdownlint-enable no-inline-html -->

---

Также напиши запросы для удаления созданных данных. Проверь, что все запросы выполняются без ошибок — как на удаление, так и на создание данных.

Сделай как минимум один коммит для этого релиза.

## Release 4. Обновить количество книг в наличии
Работай в файле `sql/update.sql`.

Мы заказывали поставку книг, и они пришли. Напиши SQL запросы для обновления данных в нужных таблицах — учти уже имеющиеся книги, а также доставленные.

Пришли следующие книги:
- ISBN 9785171048013, 10 шт. Из них 1 шт. с повреждением.
- ISBN 9785171342722, 15 шт. Из них 2 шт. с повреждением.
- ISBN 9785171037451, 10 шт. Все в хорошем состоянии.

Проверь, что запросы выполняются без ошибок.

Сделай как минимум один коммит для этого релиза.

## Release 5. Написать SQL-запросы для выборки данных
Работай в файле `sql/queries.sql`.

Используй выборку данных с помощью SQL, чтобы ответить на эти вопросы:

1. Какие книги про Дюну есть в наличии? Выведи названия книг, ISBN и количество экземпляров.
2. Сколько экземпляров книг каждого автора есть в наличии? Выведи имена авторов и количество всех экземпляров.
3. Сколько книг каждого жанра есть в наличии? Выведи названия жанров и количество книг. Разные издания одной и той же книги считаются за одну книгу для этого запроса.

Проверь, что запросы выполняются без ошибок.

Сделай как минимум один коммит для этого релиза.

## Release 6. Рассчитать процент повреждённых книг (дополнительно)
Используй SQL, чтобы ответить на вопрос: какой процент повреждённых книг от общего количества книг в наличии?

Выведи только целое число — процент повреждённых книг. Для этого запроса понадобится использовать условные выражения либо вложенный запрос.

Задачу можно разбить на следующие шаги:
1. Подсчитать общее количество книг (все копии).
2. Подсчитать количество повреждённых книг (копии с соответствующим состоянием).
3. Рассчитать процент повреждённых книг от общего количества книг.

Важно: При делении целых чисел (integer) SQL возвращает целое число с округлением вниз, поэтому можно получить 0 вместо действительного процента. Можно воспользоваться приведением типов через `CAST` — например, к типу `DECIMAL`.

Попробуй написать два решения — с использованием условных выражений и с использованием вложенного запроса. Сравни их ход выполнения и производительность с помощью `EXPLAIN ANALYZE`. Сравни оба решения в плане читаемости.

- [PostgresPro: 4.2.9. Приведения типов](https://postgrespro.ru/docs/postgresql/15/sql-expressions#SQL-SYNTAX-TYPE-CASTS)
- [PostgresPro: 9.18. Условные выражения](https://postgrespro.ru/docs/postgresql/15/functions-conditional)
- [PostgresPro: 14.1.2. EXPLAIN ANALYZE](https://postgrespro.ru/docs/postgresql/15/using-explain#USING-EXPLAIN-ANALYZE)
